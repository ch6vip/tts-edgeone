<!DOCTYPE html>
<html lang="zh-Hans">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Edge TTS</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <style>
    :root {
      --primary-color: #4F46E5;
      --success-color: #10B981;
      --error-color: #EF4444;
      --warning-color: #F59E0B;
      --light-gray: #F9FAFB;
      --gray: #6B7280;
      --border-color: #D1D5DB;
      --text-color: #1F2937;
    }

    * {
      box-sizing: border-box;
    }

    html {
      padding: 0;
      margin: 0;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
      background: var(--light-gray);
      min-height: 100vh;
      color: var(--text-color);
      line-height: 1.6;
      padding: 0;
      margin: 0;
    }

    [v-cloak] {
      display: none;
    }

    .app-container {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 2rem 0 2rem;
    }

    .container {
      max-width: 800px;
      width: 100%;
      background-color: #FFFFFF;
      padding: 2.5rem;
      border-radius: 16px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      border: 1px solid #E5E7EB;
    }

    h1 {
      text-align: center;
      color: var(--text-color);
      margin-bottom: 2.5rem;
      font-weight: 700;
      font-size: 1.875rem;
      letter-spacing: -0.025em;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text-color);
    }

    input[type="text"],
    input[type="password"],
    select,
    textarea {
      width: 100%;
      padding: 0.8rem 1rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 1rem;
      background-color: white;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    input[type="text"]:focus,
    input[type="password"]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15);
    }

    textarea {
      resize: vertical;
      min-height: 120px;
    }

    .textarea-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85rem;
      color: var(--gray);
      margin-top: 0.5rem;
    }

    .clear-btn {
      background: transparent;
      border: none;
      color: var(--gray);
      cursor: pointer;
      padding: 0.2rem 0.5rem;
      border-radius: 6px;
      transition: background-color 0.2s, color 0.2s;
    }

    .clear-btn:hover {
      background-color: #F3F4F6;
      color: var(--text-color);
    }

    .label-with-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .pause-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .pause-input {
      width: 6.5em;
      padding: 0.4rem 0.6rem;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 0.9rem;
      text-align: center;
    }

    .pause-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.15);
    }

    .btn-insert-pause {
      background: var(--primary-color);
      color: #FFFFFF;
      padding: 0.4rem 0.8rem;
      border: 1px solid var(--primary-color);
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .btn-insert-pause:hover {
      background-color: #4338CA;
    }

    .btn-insert-pause:active {
      transform: scale(0.95);
    }

    .grid-layout {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
    }

    .slider-group {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .slider-group input[type="range"] {
      flex-grow: 1;
      height: 6px;
      border-radius: 3px;
      background: #EEEEEE;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }

    .slider-group input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--primary-color);
      cursor: pointer;
      border: 3px solid white;
      box-shadow: 0 0 0 1px var(--border-color);
    }

    .slider-group input[type="range"]::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--primary-color);
      cursor: pointer;
      border: 3px solid white;
      box-shadow: 0 0 0 1px var(--border-color);
    }

    .slider-group span {
      font-weight: 500;
      min-width: 50px;
      text-align: right;
      color: var(--text-color);
      font-size: 0.9rem;
    }

    .button-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-top: 2rem;
    }

    button {
      padding: 0.9rem 1rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }

    button:active {
      transform: scale(0.97);
    }

    .btn-generate {
      background: var(--primary-color);
      color: #FFFFFF;
      border: 1px solid var(--primary-color);
    }

    .btn-stream {
      background: #FFFFFF;
      color: var(--primary-color);
      border: 1px solid var(--primary-color);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .btn-generate:hover {
      background: #4338CA;
    }

    .btn-stream:hover {
      background: #F9FAFB;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .status {
      margin-top: 1.5rem;
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
      font-weight: 500;
      display: none;
    }

    .status.show {
      display: block;
    }

    .status-info {
      background-color: #dbeafe;
      color: #1d4ed8;
      border: 1px solid #93c5fd;
    }

    .status-success {
      background-color: #dcfce7;
      color: #166534;
      border: 1px solid #86efac;
    }

    .status-error {
      background-color: #fee2e2;
      color: #dc2626;
      border: 1px solid #fca5a5;
    }

    audio {
      width: 100%;
      margin-top: 1.5rem;
      border-radius: 8px;
    }

    .download-section {
      margin-top: 1rem;
      text-align: center;
    }

    .btn-download {
      background: var(--success-color);
      color: white;
      padding: 0.8rem 1.5rem;
      border: 1px solid var(--success-color);
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-download:hover {
      background-color: #059669;
    }

    .btn-download:active {
      transform: scale(0.97);
    }

    /* æ–°å¢æ ·å¼å¼€å§‹ */
    .btn-import {
      background: #FFFFFF;
      color: var(--text-color);
      padding: 0.8rem 1.5rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
    }

    .btn-import:hover {
      background-color: #F9FAFB;
    }

    .btn-import:active {
      transform: scale(0.97);
    }

    .btn-copy {
      background: #FFFFFF;
      color: var(--text-color);
      padding: 0.8rem 1.5rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-copy:hover {
      background-color: #F9FAFB;
    }

    .btn-copy:active {
      transform: scale(0.97);
    }
    /* æ–°å¢æ ·å¼ç»“æŸ */

    details {
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1.5rem;
      background-color: #F9FAFB;
    }

    summary {
      font-weight: 600;
      cursor: pointer;
      color: var(--text-color);
      padding: 0.5rem 0;
    }

    summary:hover {
      color: var(--primary-color);
    }

    .checkbox-grid {
      margin-top: 1rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.8rem;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .checkbox-item input[type="checkbox"] {
      width: auto;
      margin: 0;
    }
    /* ç§»åŠ¨ç«¯é€‚é… */
    @media (max-width: 768px) {
      body {
        padding: 0.5rem;
      }

      .app-container {
        padding: 0 0 1rem;
      }

      .container {
        padding: 1.5rem;
        border-radius: 12px;
      }

      h1 {
        font-size: 1.5rem;
        margin-bottom: 1.5rem;
      }

      .grid-layout {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .button-group {
        grid-template-columns: 1fr;
      }

      .checkbox-grid {
        grid-template-columns: 1fr;
      }

      .slider-group span {
        min-width: 45px;
        font-size: 0.85rem;
      }

      textarea {
        min-height: 100px;
      }

      .label-with-controls {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .pause-controls {
        align-self: flex-end;
      }

      .pause-input {
        font-size: 0.85rem;
      }

      .btn-insert-pause {
        font-size: 0.8rem;
        padding: 0.35rem 0.7rem;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 1rem;
        margin: 0.5rem;
      }

      .form-group {
        margin-bottom: 1rem;
      }

      input[type="text"],
      input[type="password"],
      select,
      textarea {
        padding: 0.7rem;
        font-size: 16px;
        /* é˜²æ­¢iOSç¼©æ”¾ */
      }

      .slider-group {
        gap: 0.5rem;
      }
    }

    /* åŠ è½½åŠ¨ç”» */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* æ–°å¢ï¼šè¿›åº¦æ¡æ ·å¼ */
    .progress-container {
      margin-top: 1rem;
      padding: 1rem;
      background: #F3F4F6;
      border-radius: 8px;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #E5E7EB;
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-color), var(--success-color));
      transition: width 0.3s ease;
    }

    .progress-text {
      margin-top: 0.5rem;
      text-align: center;
      font-size: 0.9rem;
      color: var(--gray);
    }

    /* æ–°å¢ï¼šæ€§èƒ½ç»Ÿè®¡é¢æ¿æ ·å¼ */
    .performance-panel {
      margin-top: 1.5rem;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 1rem;
      background-color: #F9FAFB;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .stat-item {
      background: white;
      padding: 0.8rem;
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .stat-label {
      display: block;
      font-size: 0.85rem;
      color: var(--gray);
      margin-bottom: 0.3rem;
    }

    .stat-value {
      display: block;
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--primary-color);
    }

    /* æ–°å¢ï¼šé”™è¯¯æ—¥å¿—é¢æ¿æ ·å¼ */
    .logs-panel {
      margin-top: 1.5rem;
      border: 1px solid #FCA5A5;
      border-radius: 12px;
      padding: 1rem;
      background-color: #FEF2F2;
    }

    .logs-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
      margin-bottom: 1rem;
    }

    .btn-export-logs,
    .btn-clear-logs {
      padding: 0.5rem 1rem;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      background: white;
    }

    .btn-export-logs:hover,
    .btn-clear-logs:hover {
      background-color: #F3F4F6;
    }

    .logs-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .log-item {
      background: white;
      padding: 0.8rem;
      margin-bottom: 0.5rem;
      border-radius: 6px;
      border-left: 3px solid var(--error-color);
    }

    .log-time {
      font-size: 0.75rem;
      color: var(--gray);
      margin-bottom: 0.3rem;
    }

    .log-message {
      font-size: 0.9rem;
      color: var(--text-color);
      font-weight: 500;
      margin-bottom: 0.3rem;
    }

    .log-context {
      font-size: 0.8rem;
      color: var(--gray);
      font-style: italic;
    }
  </style>
</head>

<body>
  <div id="app" class="app-container">
    <main class="container">
      <h1 v-cloak>{{ title }}</h1>

      <details>
        <summary>API é…ç½®</summary>
        <div class="form-group" style="margin-top: 1rem">
          <label for="baseUrl">API Base URL</label>
          <input type="text" id="baseUrl" v-model="config.baseUrl" @input="debouncedSaveConfig" placeholder="https://ä½ çš„åŸŸå" />
        </div>
        <div class="form-group" style="margin-bottom: 0">
          <label for="apiKey">API Key</label>
          <input type="password" id="apiKey" v-model="config.apiKey" @input="debouncedSaveConfig" placeholder="hello" />
        </div>
      </details>

      <div class="form-group">
        <div class="label-with-controls">
          <label for="inputText">è¾“å…¥æ–‡æœ¬</label>
          <div class="pause-controls">
            <input type="number" v-model.number="pauseTime" min="0.01" max="100" step="0.01" placeholder="åœé¡¿æ—¶é•¿"
              class="pause-input" />
            <button type="button" @click="insertPause" class="btn-insert-pause" title="åœ¨å…‰æ ‡ä½ç½®æ’å…¥åœé¡¿">
              æ’å…¥åœé¡¿
            </button>
          </div>
        </div>
        <textarea id="inputText" ref="textareaRef" v-model="form.inputText" @input="debouncedSaveForm"
          placeholder="è¯·åœ¨è¿™é‡Œè¾“å…¥æ–‡æœ¬ï¼Œç›®å‰å°½å¯èƒ½ä¸è¦è¶…è¿‡1ç‚¹5ä¸‡å­—æ¯æ¬¡ï¼Œä¸ç„¶ä¼šæŠ¥é”™ã€‚éŸ³è‰²æ˜ å°„å¯ä»¥è‡ªè¡Œä¿®æ”¹EdgeOneå‡½æ•°çš„é…ç½®"></textarea>
        <div class="textarea-footer">
          <span v-cloak>{{ charCount }} å­—ç¬¦</span>
          <button class="clear-btn" @click="clearText">æ¸…é™¤</button>
        </div>
      </div>

      <div class="grid-layout">
        <div class="form-group">
          <label for="voice">é€‰æ‹©éŸ³è‰² (Model)</label>
          <select id="voice" v-model="form.voice" @change="debouncedSaveForm">
            <option value="zh-CN-XiaoxiaoNeural">ä¸­æ–‡å¥³å£° (æ™“æ™“)</option>
            <option value="zh-CN-YunxiNeural">ä¸­æ–‡ç”·å£° (äº‘å¸Œ)</option>
            <option value="zh-CN-YunyangNeural">ä¸­æ–‡ç”·å£° (äº‘æ‰¬)</option>
            <option value="zh-CN-XiaoyiNeural">ä¸­æ–‡å¥³å£° (æ™“ä¼Š)</option>
            <option value="zh-CN-YunjianNeural">ä¸­æ–‡ç”·å£° (äº‘å¥)</option>
            <option value="zh-CN-XiaochenNeural">ä¸­æ–‡å¥³å£° (æ™“è¾°)</option>
            <option value="zh-CN-XiaohanNeural">ä¸­æ–‡å¥³å£° (æ™“æ¶µ)</option>
            <option value="zh-CN-XiaomengNeural">ä¸­æ–‡å¥³å£° (æ™“æ¢¦)</option>
            <option value="zh-CN-XiaomoNeural">ä¸­æ–‡å¥³å£° (æ™“å¢¨)</option>
            <option value="zh-CN-XiaoqiuNeural">ä¸­æ–‡å¥³å£° (æ™“ç§‹)</option>
            <option value="zh-CN-XiaoruiNeural">ä¸­æ–‡å¥³å£° (æ™“ç¿)</option>
            <option value="zh-CN-XiaoshuangNeural">ä¸­æ–‡å¥³å£° (æ™“åŒ)</option>
            <option value="zh-CN-XiaoxuanNeural">ä¸­æ–‡å¥³å£° (æ™“è±)</option>
            <option value="zh-CN-XiaoyanNeural">ä¸­æ–‡å¥³å£° (æ™“é¢œ)</option>
            <option value="zh-CN-XiaoyouNeural">ä¸­æ–‡å¥³å£° (æ™“æ‚ )</option>
            <option value="zh-CN-XiaozhenNeural">ä¸­æ–‡å¥³å£° (æ™“ç”„)</option>
            <option value="zh-CN-YunfengNeural">ä¸­æ–‡ç”·å£° (äº‘æ«)</option>
            <option value="zh-CN-YunhaoNeural">ä¸­æ–‡ç”·å£° (äº‘çš“)</option>
            <option value="zh-CN-YunxiaNeural">ä¸­æ–‡ç”·å£° (äº‘å¤)</option>
            <option value="zh-CN-YunyeNeural">ä¸­æ–‡ç”·å£° (äº‘é‡)</option>
            <option value="zh-CN-YunzeNeural">ä¸­æ–‡ç”·å£° (äº‘æ³½)</option>
            <option value="en-US-JennyNeural">è‹±æ–‡å¥³å£° (Jenny)</option>
            <option value="en-US-GuyNeural">è‹±æ–‡ç”·å£° (Guy)</option>
            <option value="en-US-AriaNeural">è‹±æ–‡å¥³å£° (Aria)</option>
            <option value="en-US-DavisNeural">è‹±æ–‡ç”·å£° (Davis)</option>
            <option value="en-US-AmberNeural">è‹±æ–‡å¥³å£° (Amber)</option>
            <option value="en-US-AnaNeural">è‹±æ–‡å¥³å£° (Ana)</option>
            <option value="en-US-AshleyNeural">è‹±æ–‡å¥³å£° (Ashley)</option>
            <option value="en-US-BrandonNeural">è‹±æ–‡ç”·å£° (Brandon)</option>
            <option value="en-US-ChristopherNeural">è‹±æ–‡ç”·å£° (Christopher)</option>
            <option value="en-US-CoraNeural">è‹±æ–‡å¥³å£° (Cora)</option>
            <option value="en-US-ElizabethNeural">è‹±æ–‡å¥³å£° (Elizabeth)</option>
            <option value="en-US-EricNeural">è‹±æ–‡ç”·å£° (Eric)</option>
            <option value="en-US-JacobNeural">è‹±æ–‡ç”·å£° (Jacob)</option>
            <option value="en-US-JaneNeural">è‹±æ–‡å¥³å£° (Jane)</option>
            <option value="en-US-JasonNeural">è‹±æ–‡ç”·å£° (Jason)</option>
            <option value="en-US-MichelleNeural">è‹±æ–‡å¥³å£° (Michelle)</option>
            <option value="en-US-MonicaNeural">è‹±æ–‡å¥³å£° (Monica)</option>
            <option value="en-US-NancyNeural">è‹±æ–‡å¥³å£° (Nancy)</option>
            <option value="en-US-RogerNeural">è‹±æ–‡ç”·å£° (Roger)</option>
            <option value="en-US-SaraNeural">è‹±æ–‡å¥³å£° (Sara)</option>
            <option value="en-US-SteffanNeural">è‹±æ–‡ç”·å£° (Steffan)</option>
            <option value="en-US-TonyNeural">è‹±æ–‡ç”·å£° (Tony)</option>
          </select>
        </div>
        <div class="form-group">
          <label>è¯­é€Ÿ</label>
          <div class="slider-group">
            <input type="range" v-model.number="form.speed" @input="debouncedSaveForm" min="0.25" max="2.0" step="0.05" />
            <span v-cloak>{{ speedDisplay }}</span>
          </div>
        </div>
        <div class="form-group">
          <label>éŸ³è°ƒ</label>
          <div class="slider-group">
            <input type="range" v-model.number="form.pitch" @input="debouncedSaveForm" min="0.5" max="1.5" step="0.05" />
            <span v-cloak>{{ pitchDisplay }}</span>
          </div>
        </div>
      </div>

      <details>
        <summary>é«˜çº§æ–‡æœ¬æ¸…ç†é€‰é¡¹</summary>
        <div class="checkbox-grid">
          <label class="checkbox-item">
            <input type="checkbox" v-model="form.cleaning.removeMarkdown" @change="debouncedSaveForm" />
            ç§»é™¤ Markdown
          </label>
          <label class="checkbox-item">
            <input type="checkbox" v-model="form.cleaning.removeEmoji" @change="debouncedSaveForm" />
            ç§»é™¤ Emoji
          </label>
          <label class="checkbox-item">
            <input type="checkbox" v-model="form.cleaning.removeUrls" @change="debouncedSaveForm" />
            ç§»é™¤ URL
          </label>
          <label class="checkbox-item">
            <input type="checkbox" v-model="form.cleaning.removeLineBreaks" @change="debouncedSaveForm" />
            ç§»é™¤æ‰€æœ‰ç©ºç™½/æ¢è¡Œ
          </label>
          <label class="checkbox-item">
            <input type="checkbox" v-model="form.cleaning.removeCitation" @change="debouncedSaveForm" />
            ç§»é™¤å¼•ç”¨æ ‡è®°æ•°å­—
          </label>
        </div>
        <div class="form-group" style="margin-top: 1rem; margin-bottom: 0">
          <label for="customKeywords">è‡ªå®šä¹‰ç§»é™¤å…³é”®è¯ (é€—å·åˆ†éš”)</label>
          <input type="text" id="customKeywords" v-model="form.cleaning.customKeywords" @input="debouncedSaveForm"
            placeholder="ä¾‹å¦‚: ABC,XYZ" />
        </div>
      </details>

      <div class="button-group">
        <button class="btn-generate" v-cloak :disabled="isLoading" @click="generateSpeech(false)">
          <span v-if="isLoading && !isStreaming" class="loading"></span>
          {{ isLoading && !isStreaming ? 'ç”Ÿæˆä¸­...' : 'ç”Ÿæˆè¯­éŸ³ (æ ‡å‡†)' }}
        </button>
        <button class="btn-stream" v-cloak :disabled="isLoading" @click="generateSpeech(true)">
          <span v-if="isLoading && isStreaming" class="loading"></span>
          {{ isLoading && isStreaming ? 'æµå¼æ’­æ”¾ä¸­...' : 'ç”Ÿæˆè¯­éŸ³ (æµå¼)' }}
        </button>
      </div>

      <div class="status" :class="['status-' + status.type, { show: status.show }]" v-cloak>
        {{ status.message }}
      </div>

      <!-- æ–°å¢ï¼šè¿›åº¦æ¡ -->
      <div v-if="isLoading" class="progress-container">
        <div class="progress-bar">
          <div class="progress-fill" :style="{ width: loadingProgress + '%' }"></div>
        </div>
        <div class="progress-text">{{ loadingProgress }}%</div>
      </div>

      <audio ref="audioPlayer" controls v-show="audioSrc" v-cloak :src="audioSrc" @loadstart="onAudioLoadStart"
        @canplay="onAudioCanPlay"></audio>

      <!-- ä¸‹è½½æŒ‰é’® -->
      <div v-if="showDownloadBtn" class="download-section" v-cloak>
        <button class="btn-download" @click="downloadAudio">
          <span>ğŸ“¥</span> ä¸‹è½½éŸ³é¢‘
        </button>

        <button class="btn-import" @click="importToLegado" style="margin-left: 10px;">
          <span>ğŸ“–</span> ä¸€é”®å¯¼å…¥
        </button>

        <button class="btn-copy" @click="copyLegadoJson" style="margin-left: 10px;">
          <span>ğŸ“‹</span> å¤åˆ¶é…ç½®
        </button>
      </div>

      <!-- æ–°å¢ï¼šæ€§èƒ½ç»Ÿè®¡é¢æ¿ -->
      <details v-if="performanceMetrics.generationTime > 0" class="performance-panel">
        <summary>âš¡ æ€§èƒ½ç»Ÿè®¡</summary>
        <div class="stats-grid">
          <div class="stat-item">
            <span class="stat-label">ç”Ÿæˆè€—æ—¶:</span>
            <span class="stat-value">{{ performanceMetrics.generationTime.toFixed(2) }}s</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">éŸ³é¢‘å¤§å°:</span>
            <span class="stat-value">{{ formatSize(performanceMetrics.audioSize) }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">å­—ç¬¦æ•°:</span>
            <span class="stat-value">{{ charCount }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">å¹³å‡é€Ÿåº¦:</span>
            <span class="stat-value">{{ calculateSpeed() }} å­—ç¬¦/ç§’</span>
          </div>
        </div>
      </details>

      <!-- æ–°å¢ï¼šé”™è¯¯æ—¥å¿—é¢æ¿ -->
      <details v-if="errorLogs.length > 0" class="logs-panel">
        <summary>ğŸ” é”™è¯¯æ—¥å¿— ({{ errorLogs.length }})</summary>
        <div class="logs-actions">
          <button @click="exportLogs" class="btn-export-logs">ğŸ“¥ å¯¼å‡ºæ—¥å¿—</button>
          <button @click="clearLogs" class="btn-clear-logs">ğŸ—‘ï¸ æ¸…é™¤æ—¥å¿—</button>
        </div>
        <div class="logs-list">
          <div v-for="log in errorLogs.slice(0, 10)" :key="log.id" class="log-item">
            <div class="log-time">{{ log.timestamp }}</div>
            <div class="log-message">{{ log.message }}</div>
            <div class="log-context" v-if="log.context">ä¸Šä¸‹æ–‡: {{ log.context }}</div>
          </div>
        </div>
      </details>
    </main>
  </div>

  <!-- Vue 3 CDN (ç”Ÿäº§ç‰ˆæœ¬) -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

  <script>
    // é˜²æŠ–å·¥å…·å‡½æ•°
    function debounce(fn, delay) {
      let timeoutId;
      return function(...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => fn.apply(this, args), delay);
      };
    }

    const { createApp } = Vue;

    createApp({
      data() {
        return {
          title: 'Edge TTS',
          isLoading: false,
          isStreaming: false,
          audioSrc: '',
          downloadUrl: '', // æ·»åŠ ä¸‹è½½é“¾æ¥
          showDownloadBtn: false, // æ§åˆ¶ä¸‹è½½æŒ‰é’®æ˜¾ç¤º
          pauseTime: 1.0, // åœé¡¿æ—¶é—´
          loadingProgress: 0, // æ–°å¢ï¼šåŠ è½½è¿›åº¦
          estimatedTime: 0, // æ–°å¢ï¼šé¢„è®¡å‰©ä½™æ—¶é—´
          performanceMetrics: { // æ–°å¢ï¼šæ€§èƒ½æŒ‡æ ‡
            startTime: 0,
            endTime: 0,
            audioSize: 0,
            generationTime: 0
          },
          errorLogs: [], // æ–°å¢ï¼šé”™è¯¯æ—¥å¿—
          maxLogs: 50, // æ–°å¢ï¼šæœ€å¤§æ—¥å¿—æ•°
          config: {
            baseUrl: window.location.origin,
            apiKey: 'hello'
          },
          form: {
            inputText: 'è¯·åœ¨è¿™é‡Œè¾“å…¥æ–‡æœ¬ï¼Œç›®å‰å°½å¯èƒ½ä¸è¦è¶…è¿‡1ç‚¹5ä¸‡å­—æ¯æ¬¡ï¼Œä¸ç„¶ä¼šæŠ¥é”™ã€‚éŸ³è‰²æ˜ å°„å¯ä»¥è‡ªè¡Œä¿®æ”¹EdgeOneå‡½æ•°çš„é…ç½®',
            voice: 'zh-CN-XiaoxiaoNeural',
            speed: 1.0,
            pitch: 1.0,
            cleaning: {
              removeMarkdown: true,
              removeEmoji: true,
              removeUrls: true,
              removeLineBreaks: true,
              removeCitation: true,
              customKeywords: ''
            }
          },
          status: {
            show: false,
            message: '',
            type: 'info'
          }
        }
      },
      computed: {
        charCount() {
          return this.form.inputText.length;
        },
        speedDisplay() {
          return this.form.speed.toFixed(2);
        },
        pitchDisplay() {
          return this.form.pitch.toFixed(2);
        }
      },
      created() {
        // åˆ›å»ºé˜²æŠ–æ–¹æ³•
        this.debouncedSaveForm = debounce(this.saveForm.bind(this), 500);
        this.debouncedSaveConfig = debounce(this.saveConfig.bind(this), 500);
      },
      methods: {
        loadConfig() {
          try {
            const saved = localStorage.getItem('tts_config');
            if (saved) {
              this.config = { ...this.config, ...JSON.parse(saved) };
              if (this.config.baseUrl.endsWith('/')) {
                this.config.baseUrl = this.config.baseUrl.slice(0, -1); // å»é™¤æœ«å°¾çš„æ–œæ 
              }
            }
          } catch (e) {
            console.warn('Failed to load config from localStorage:', e);
          }
        },
        saveConfig() {
          try {
            localStorage.setItem('tts_config', JSON.stringify(this.config));
          } catch (e) {
            console.warn('Failed to save config to localStorage:', e);
          }
        },
        loadForm() {
          try {
            const saved = localStorage.getItem('tts_form');
            if (saved) {
              this.form = { ...this.form, ...JSON.parse(saved) };
            }
          } catch (e) {
            console.warn('Failed to load form from localStorage:', e);
          }
        },
        saveForm() {
          try {
            localStorage.setItem('tts_form', JSON.stringify(this.form));
          } catch (e) {
            console.warn('Failed to save form to localStorage:', e);
          }
        },
        clearText() {
          this.form.inputText = '';
          this.saveForm();
        },
        downloadAudio() {
          if (this.downloadUrl) {
            const link = document.createElement('a');
            link.href = this.downloadUrl;
            let timeString = (new Date().toLocaleString() + '-').replace(/[\/\:]/g, '-').replace(/\s/g, '_').replace(/[-_](\d)[-_]/g, '-0$1-').slice(0, -1);
            link.download = 'tts-audio-' + timeString + '.mp3';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          }
        },

        // æ–°å¢æ–¹æ³• 1: ä¸€é”®å¯¼å…¥åˆ°é˜…è¯» APP
        importToLegado() {
          const baseUrl = this.config.baseUrl.trim();
          const apiKey = this.config.apiKey.trim();
          const voice = this.form.voice;
          // è‡ªåŠ¨ç”Ÿæˆç®€çŸ­åç§°ï¼Œå¦‚ EdgeOne-Xiaoxiao
          const shortName = voice.split('-')[2]?.replace('Neural', '') || voice;
          const name = `EdgeOne-${shortName}`;

          if (!baseUrl) {
            this.updateStatus('è¯·å…ˆå¡«å†™ API Base URL', 'error');
            return;
          }

          // 1. æ„å»º reader æ¥å£åœ°å€ (æ³¨æ„åŒ…å«äº† key å‚æ•°)
          const readerApiUrl = `${baseUrl}/reader?voice=${voice}&n=${name}&key=${apiKey}`;

          // 2. æ„å»ºé˜…è¯» APP çš„å¯¼å…¥åè®®é“¾æ¥
          const legadoDeepLink = `legado://import/http_tts?src=${encodeURIComponent(readerApiUrl)}`;

          // 3. å°è¯•å”¤èµ· APP
          this.updateStatus('æ­£åœ¨å”¤èµ·é˜…è¯»APP...', 'info');
          window.location.href = legadoDeepLink;

          setTimeout(() => {
             this.updateStatus('å·²å‘é€å”¤èµ·è¯·æ±‚ã€‚å¦‚æœªè·³è½¬ï¼Œè¯·å°è¯•ä½¿ç”¨â€œå¤åˆ¶é…ç½®â€åŠŸèƒ½ã€‚', 'success');
          }, 2000);
        },

        // æ–°å¢æ–¹æ³• 2: å¤åˆ¶ JSON é…ç½® (æ— éœ€åç«¯ reader æ¥å£)
        async copyLegadoJson() {
          const baseUrl = this.config.baseUrl.trim();
          const apiKey = this.config.apiKey.trim();
          const voice = this.form.voice;
          const shortName = voice.split('-')[2]?.replace('Neural', '') || voice;
          const sourceName = `EdgeOne-${shortName}`;

          if (!baseUrl) {
            this.updateStatus('è¯·å…ˆå¡«å†™ API Base URL', 'error');
            return;
          }

          // æ„å»ºé˜…è¯» APP çš„æºé…ç½®å¯¹è±¡
          // é‡ç‚¹ï¼šURL ä¸­å¿…é¡»åŒ…å« &key=${apiKey} ä»¥é€šè¿‡ EdgeOne éªŒè¯
          const legacyConfig = {
            "concurrentRate": "0",
            "contentType": "audio/mpeg",
            "header": JSON.stringify({ "Authorization": `Bearer ${apiKey}` }),
            "id": Date.now(),
            "loginUrl": "",
            "name": sourceName,
            "url": `${baseUrl}/api/v1/audio/speech?t={{java.encodeURI(speakText)}}&v=${voice}&r={{(speakSpeed - 10) / 10 + 1}}&p=1.0&key=${apiKey}`
          };

          // å°è£…æˆæ•°ç»„
          const jsonString = JSON.stringify([legacyConfig], null, 2);

          try {
            await navigator.clipboard.writeText(jsonString);
            this.updateStatus('âœ… é…ç½®å·²å¤åˆ¶ï¼è¯·æ‰“å¼€â€œé˜…è¯»â€APP -> è®¾ç½® -> TTSå¼•æ“ -> å³ä¸Šè§’èœå• -> å‰ªè´´æ¿å¯¼å…¥', 'success');
          } catch (err) {
            console.error('å¤åˆ¶å¤±è´¥:', err);
            this.updateStatus('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶æ§åˆ¶å°ä¸­çš„ JSON', 'error');
          }
        },
        // æ–°å¢ï¼šå‹å¥½é”™è¯¯å¤„ç†
        handleFriendlyError(error) {
          const errorMap = {
            'Failed to fetch': {
              message: 'ğŸŒ ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®',
              suggestion: 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•'
            },
            '401': {
              message: 'ğŸ”‘ API Key éªŒè¯å¤±è´¥',
              suggestion: 'è¯·æ£€æŸ¥ API é…ç½®ä¸­çš„å¯†é’¥æ˜¯å¦æ­£ç¡®'
            },
            '413': {
              message: 'ğŸ“ æ–‡æœ¬å†…å®¹è¿‡é•¿',
              suggestion: 'è¯·å‡å°‘æ–‡å­—æ•°é‡è‡³ 1.5 ä¸‡å­—ä»¥å†…'
            },
            '500': {
              message: 'âš ï¸ æœåŠ¡å™¨é”™è¯¯',
              suggestion: 'æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•'
            }
          };

          let errorInfo = null;
          for (const [key, value] of Object.entries(errorMap)) {
            if (error.message.includes(key) || error.toString().includes(key)) {
              errorInfo = value;
              break;
            }
          }

          if (!errorInfo) {
            errorInfo = {
              message: 'âŒ å‘ç”Ÿé”™è¯¯',
              suggestion: error.message
            };
          }

          this.updateStatus(`${errorInfo.message}\n${errorInfo.suggestion}`, 'error');
        },
        // æ–°å¢ï¼šé”™è¯¯æ—¥å¿—è®°å½•
        logError(error, context = '') {
          const log = {
            id: Date.now(),
            timestamp: new Date().toLocaleString('zh-CN'),
            message: error.message,
            stack: error.stack || '',
            context,
            userAgent: navigator.userAgent
          };

          this.errorLogs.unshift(log);
          if (this.errorLogs.length > this.maxLogs) {
            this.errorLogs.pop();
          }

          try {
            localStorage.setItem('tts_error_logs', JSON.stringify(this.errorLogs.slice(0, 10)));
          } catch (e) {
            console.warn('Failed to save error logs:', e);
          }
        },
        // æ–°å¢ï¼šå¯¼å‡ºæ—¥å¿—
        exportLogs() {
          const dataStr = JSON.stringify(this.errorLogs, null, 2);
          const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
          const exportFileDefaultName = `tts-error-logs-${Date.now()}.json`;

          const linkElement = document.createElement('a');
          linkElement.setAttribute('href', dataUri);
          linkElement.setAttribute('download', exportFileDefaultName);
          linkElement.click();
        },
        // æ–°å¢ï¼šæ¸…é™¤æ—¥å¿—
        clearLogs() {
          this.errorLogs = [];
          localStorage.removeItem('tts_error_logs');
          this.updateStatus('æ—¥å¿—å·²æ¸…é™¤', 'success');
        },
        // æ–°å¢ï¼šæ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        formatSize(bytes) {
          if (!bytes || bytes === 0) return '0 B';
          const k = 1024;
          const sizes = ['B', 'KB', 'MB', 'GB'];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
        },
        // æ–°å¢ï¼šè®¡ç®—ç”Ÿæˆé€Ÿåº¦
        calculateSpeed() {
          if (this.performanceMetrics.generationTime === 0) return 0;
          return Math.round(this.charCount / this.performanceMetrics.generationTime);
        },
        updateStatus(message, type = 'info') {
          this.status = {
            show: true,
            message,
            type
          };
        },
        hideStatus() {
          this.status.show = false;
        },
        getRequestBody() {
          return {
            voice: this.form.voice,
            input: this.form.inputText.trim(),
            speed: this.form.speed,
            pitch: this.form.pitch,
            cleaning_options: {
              remove_markdown: this.form.cleaning.removeMarkdown,
              remove_emoji: this.form.cleaning.removeEmoji,
              remove_urls: this.form.cleaning.removeUrls,
              remove_line_breaks: this.form.cleaning.removeLineBreaks,
              remove_citation_numbers: this.form.cleaning.removeCitation,
              custom_keywords: this.form.cleaning.customKeywords,
            },
          };
        },
        async generateSpeech(isStream) {
          const baseUrl = this.config.baseUrl.trim();
          const apiKey = this.config.apiKey.trim();
          const text = this.form.inputText.trim();

          if (!baseUrl || !apiKey || !text) {
            this.updateStatus('è¯·å¡«å†™ API é…ç½®å’Œè¾“å…¥æ–‡æœ¬', 'error');
            return;
          }

          // éªŒè¯ API Key æ˜¯å¦åŒ…å«é ASCII å­—ç¬¦
          try {
            new Headers({ 'Authorization': 'Bearer ' + apiKey });
          } catch (e) {
            this.updateStatus('API Key åŒ…å«æ— æ•ˆå­—ç¬¦ï¼Œè¯·ä½¿ç”¨çº¯è‹±æ–‡æ•°å­—å’Œç¬¦å·', 'error');
            return;
          }

          const requestBody = this.getRequestBody();
          requestBody.stream = isStream;

          // è®°å½•å¼€å§‹æ—¶é—´
          this.performanceMetrics.startTime = Date.now();
          this.isLoading = true;
          this.isStreaming = isStream;
          this.audioSrc = '';
          this.showDownloadBtn = false;
          this.loadingProgress = 0; // é‡ç½®è¿›åº¦
          if (this.downloadUrl) {
            URL.revokeObjectURL(this.downloadUrl);
            this.downloadUrl = '';
          }
          this.updateStatus('æ­£åœ¨è¿æ¥æœåŠ¡å™¨...', 'info');

          try {
            if (isStream) {
              await this.playStreamWithMSE(baseUrl, apiKey, requestBody);
            } else {
              await this.playStandard(baseUrl, apiKey, requestBody);
            }

            // è®°å½•ç»“æŸæ—¶é—´å’Œæ€§èƒ½æ•°æ®
            this.performanceMetrics.endTime = Date.now();
            this.performanceMetrics.generationTime =
              (this.performanceMetrics.endTime - this.performanceMetrics.startTime) / 1000;
          } catch (error) {
            console.error('Error generating speech:', error);
            this.logError(error, 'generateSpeech'); // è®°å½•é”™è¯¯æ—¥å¿—
            this.handleFriendlyError(error); // å‹å¥½é”™è¯¯æç¤º
          } finally {
            this.isLoading = false;
            this.isStreaming = false;
          }
        },
        async playStandard(baseUrl, apiKey, body) {
          const response = await fetch(baseUrl + '/api/v1/audio/speech', {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer ' + apiKey,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(body),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              errorData.error?.message ||
              'HTTP error! status: ' + response.status
            );
          }

          const blob = await response.blob();
          this.performanceMetrics.audioSize = blob.size; // è®°å½•éŸ³é¢‘å¤§å°
          this.audioSrc = URL.createObjectURL(blob);
          this.downloadUrl = this.audioSrc; // éæµå¼æ¨¡å¼ç›´æ¥ä½¿ç”¨ç›¸åŒçš„URL
          this.showDownloadBtn = true;
          this.updateStatus('æ’­æ”¾ä¸­...', 'success');

          // è‡ªåŠ¨æ’­æ”¾
          this.$nextTick(() => {
            this.$refs.audioPlayer.play().catch(e =>
              console.warn('Autoplay was prevented:', e)
            );
          });
        },
        async playStreamWithMSE(baseUrl, apiKey, body) {
          const mediaSource = new MediaSource();
          this.audioSrc = URL.createObjectURL(mediaSource);

          // ç”¨äºæ”¶é›†éŸ³é¢‘æ•°æ®çš„æ•°ç»„
          const audioChunks = [];

          return new Promise((resolve, reject) => {
            mediaSource.addEventListener('sourceopen', async () => {
              URL.revokeObjectURL(this.audioSrc);
              const sourceBuffer = mediaSource.addSourceBuffer('audio/mpeg');

              try {
                const response = await fetch(baseUrl + '/api/v1/audio/speech', {
                  method: 'POST',
                  headers: {
                    'Authorization': 'Bearer ' + apiKey,
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(body),
                });

                if (!response.ok) {
                  const errorData = await response.json();
                  throw new Error(
                    errorData.error?.message ||
                    'HTTP error! status: ' + response.status
                  );
                }

                this.updateStatus('å·²è¿æ¥ï¼Œæ¥æ”¶æ•°æ®ä¸­...', 'info');

                // è‡ªåŠ¨æ’­æ”¾
                this.$nextTick(() => {
                  this.$refs.audioPlayer.play().catch(e =>
                    console.warn('Autoplay was prevented:', e)
                  );
                });

                const reader = response.body.getReader();

                const pump = async () => {
                  const { done, value } = await reader.read();

                  if (done) {
                    if (mediaSource.readyState === 'open' && !sourceBuffer.updating) {
                      mediaSource.endOfStream();
                    }

                    // åˆ›å»ºå®Œæ•´çš„éŸ³é¢‘æ–‡ä»¶ç”¨äºä¸‹è½½
                    const completeAudioBlob = new Blob(audioChunks, { type: 'audio/mpeg' });
                    this.downloadUrl = URL.createObjectURL(completeAudioBlob);
                    this.showDownloadBtn = true;

                    this.updateStatus('æ’­æ”¾å®Œæ¯•ï¼å¯ç‚¹å‡»ä¸‹è½½æŒ‰é’®ä¿å­˜éŸ³é¢‘', 'success');
                    resolve();
                    return;
                  }

                  // æ”¶é›†éŸ³é¢‘æ•°æ®å—
                  audioChunks.push(value.slice()); // ä½¿ç”¨slice()åˆ›å»ºå‰¯æœ¬

                  if (sourceBuffer.updating) {
                    await new Promise(resolve =>
                      sourceBuffer.addEventListener('updateend', resolve, { once: true })
                    );
                  }

                  sourceBuffer.appendBuffer(value);
                  this.updateStatus('æ­£åœ¨æµå¼æ’­æ”¾...', 'success');
                };

                sourceBuffer.addEventListener('updateend', pump);
                await pump();
              } catch (error) {
                console.error('Error in MSE streaming:', error);
                this.updateStatus('é”™è¯¯: ' + error.message, 'error');
                if (mediaSource.readyState === 'open') {
                  try {
                    mediaSource.endOfStream();
                  } catch (e) { }
                }
                reject(error);
              }
            }, { once: true });
          });
        },
        onAudioLoadStart() {
          console.log('Audio loading started');
        },
        onAudioCanPlay() {
          console.log('Audio can play');
        },
        // æ’å…¥åœé¡¿æ ‡ç­¾
        insertPause() {
          const textarea = this.$refs.textareaRef;
          if (!textarea) return;
          if (!this.pauseTime || this.pauseTime <= 0 || this.pauseTime > 100) {
            window.alert('åœé¡¿æ—¶é—´å¿…é¡»åœ¨ 0.01 åˆ° 100 ç§’ä¹‹é—´', 'error');
            return;
          }

          const start = textarea.selectionStart;
          const end = textarea.selectionEnd;
          const breakTag = '<break time="' + this.pauseTime + 's"/>';

          const newText = this.form.inputText.slice(0, start) +
            breakTag +
            this.form.inputText.slice(end);

          this.form.inputText = newText;

          // ä¿æŒå…‰æ ‡ä½ç½®
          this.$nextTick(() => {
            const newPos = start + breakTag.length;
            textarea.focus();
            textarea.setSelectionRange(newPos, newPos);
          });
        }
      },
      mounted() {
        this.loadConfig();
        this.loadForm();
      },
      beforeUnmount() {
        // æ¸…ç†URLå¯¹è±¡ï¼Œé¿å…å†…å­˜æ³„æ¼
        if (this.audioSrc) {
          URL.revokeObjectURL(this.audioSrc);
        }
        if (this.downloadUrl && this.downloadUrl !== this.audioSrc) {
          URL.revokeObjectURL(this.downloadUrl);
        }
      }
    }).mount('#app');
  </script>
</body>

</html>
